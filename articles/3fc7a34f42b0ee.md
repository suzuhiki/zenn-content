---
title: "uvã‚’ç”¨ã„ã¦fairseqã‚’editableã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹"
emoji: "ğŸ”°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["fairseq","uv","python","æ©Ÿæ¢°å­¦ç¿’"]
published: true
---

# ã¯ã˜ã‚ã«
ç ”ç©¶ã§fairseqã‚’åˆ©ç”¨ã™ã‚‹éš›ã«ã€pipã§ã¯ãªãuvã§editableã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚‰ãšè©°ã¾ã£ãŸã®ã§ã€å‹•ã„ãŸè¨˜éŒ²ã‚’å…±æœ‰ã—ã¾ã™ã€‚
[uv](https://docs.astral.sh/uv/)ã¯pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‹ã‚‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã¾ã§è¡Œãˆã‚‹ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
åˆ©ç”¨ã‚’é–‹å§‹ã™ã‚‹éš›ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
https://zenn.dev/turing_motors/articles/594fbef42a36ee

:::message alert
--è¿½è¨˜--
å…¬å¼ã®pytorchå°å…¥ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ã§ã¯ãªãã€ãƒªãƒ³ã‚¯å…ˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ²¿ã£ã¦å°å…¥ã—ã¦ãã ã•ã„ã€‚
https://docs.astral.sh/uv/guides/integration/pytorch/
:::

# ä½œæ¥­æ‰‹é †

:::message
ã“ã®è¨˜äº‹ã§ã¯ã¾ã£ã•ã‚‰ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆã‹ã‚‰åˆã‚ã¦fairseqã§ç”Ÿæˆã‚’è¡Œã†ã¨ã“ã‚ã¾ã§ã‚’æ‰±ã„ã¾ã™ã€‚
:::
## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™
```shell
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
mkdir fairseq_test
cd fairseq_test

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
uv init
uv python pin 3.10

# fairseqã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/pytorch/fairseq
```
## ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å®šç¾©
`fairseq==0.12.2`ã¯`torch==1.12.1+cu113`ã¨`numpy==1.26.4`ã®çµ„ã¿åˆã‚ã›ã§å‹•ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã«pyproject.tomlã‚’ç·¨é›†ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚
```toml
[project]
name = "fairseq_test"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.10"
dependencies = [
    "fairseq",
    "torch==1.12.1+cu113",
    "torchvision==0.13.1+cu113",
    "numpy==1.26.4",
]

[tool.uv]
find-links = [
    "https://download.pytorch.org/whl/cu113/torch",
    "https://download.pytorch.org/whl/cu113/torchvision",
]

[tool.uv.sources]
fairseq = { path = "fairseq", editable = true }
```
## fairseqã®ä¾å­˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿®æ­£
fairseqã¯`torch>=1.13`ã—ã‹å—ã‘ä»˜ã‘ã¾ã›ã‚“ã€‚1.12ã‚’åˆ©ç”¨ã—ãŸã„ã®ã§ä¿®æ­£ã—ã¾ã™ã€‚
`fairseq/setup.py`ã®`torch>=1.13`ã¨è¨˜è¼‰ã®éƒ¨åˆ†ã‚’1.11ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚
```diff python
~~~       
        long_description_content_type="text/markdown",
        install_requires=[
            "cffi",
            "cython",
            "hydra-core>=1.0.7,<1.1",
            "omegaconf<2.1",
            "numpy>=1.21.3",
            "regex",
            "sacrebleu>=1.4.12",
-            "torch>=1.13",
+            "torch>=1.11",
            "tqdm",
            "bitarray",
            "torchaudio>=0.8.0",
            "scikit-learn",
            "packaging",
        ],
 ~~~
```
## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã“ã®çŠ¶æ…‹ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ç§ã®ç’°å¢ƒã§ã¯`CXX`ã®å¤‰æ•°ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
```bash
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
CXX=g++ uv sync
```
## ãƒ†ã‚¹ãƒˆ
æ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸã‹ç¢ºèªã—ã¾ã™ã€‚
ã“ã“ã§ã¯ã€fairseqã«å«ã¾ã‚Œã‚‹exampleã®æ¨è«–ã‚’è¡Œã£ã¦ã¿ã¾ã™ã€‚
https://github.com/facebookresearch/fairseq/tree/main/examples/translation#example-usage-cli-tools

ä¸Šè¨˜ã®ä¾‹ã‚’å‚è€ƒã«shellãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
`test.sh`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
uv runã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚
```bash:test.sh
mkdir -p data-bin
curl https://dl.fbaipublicfiles.com/fairseq/models/wmt14.v2.en-fr.fconv-py.tar.bz2 | tar xvjf - -C data-bin
curl https://dl.fbaipublicfiles.com/fairseq/data/wmt14.v2.en-fr.newstest2014.tar.bz2 | tar xvjf - -C data-bin
CUDA_VISIBLE_DEVICES=1 uv run fairseq-generate data-bin/wmt14.en-fr.newstest2014 \
    --path data-bin/wmt14.en-fr.fconv-py/model.pt \
    --beam 5 --batch-size 128 --remove-bpe | tee ./tmp/gen.out
# ...
# | Translated 3003 sentences (96311 tokens) in 166.0s (580.04 tokens/s)
# | Generate test with beam=5: BLEU4 = 40.83, 67.5/46.9/34.4/25.5 (BP=1.000, ratio=1.006, syslen=83262, reflen=82787)

# Compute BLEU score
grep ^H ./tmp/gen.out | cut -f3- >./tmp/gen.out.sys
grep ^T ./tmp/gen.out | cut -f2- >./tmp/gen.out.ref
uv run fairseq-score --sys ./tmp/gen.out.sys --ref ./tmp/gen.out.ref
# BLEU4 = 40.83, 67.5/46.9/34.4/25.5 (BP=1.000, ratio=1.006, syslen=83262, reflen=82787)
```
å®Ÿè¡Œçµæœã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
```bash
BLEU4 = 40.82, 67.5/46.9/34.4/25.5 (BP=1.000, ratio=1.006, syslen=83021, reflen=82565)
```
# ãŠã‚ã‚Šã«
ã“ã®è¨˜äº‹ã§ã¯uvã‚’ç”¨ã„ã¦fairseqã‚’editableã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
è§£æ±ºã®æ‰‹åŠ©ã‘ã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚